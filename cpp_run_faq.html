<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>C++运行常见问题</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax:{
        inlineMath: [["\\(", "\\)"]],
        displayMath: [['$$','$$'],["\\[","\\]"]],
        processEscapes: true
    },
    "HTML-CSS": {fonts: ["TeX"]},
    TeX: {
        extensions: ["AMSmath.js", "AMSsymbols.js", "noErrors.js", "noUndefined.js"],
        equationNumbers: {autoNumber: "all"},
    }
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('cpp_run_faq.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">C++运行常见问题 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
 <h1><a class="anchor" id="system_work_dir"></a>
system()函数工作路径？</h1>
<p>system（）函数即使调用了其他路径的可执行文件，可执行文件也相当于在当前路径下运行，举个例子，在~/目录下运行a.exe，a.exe里有一句话是 </p><div class="fragment"><div class="line">system(<span class="stringliteral">&quot;f/b.exe&quot;</span>);</div></div><!-- fragment --><p> b.exe在代码里写这一句生成"c.txt"文件。 那么这个c.txt到第一会在哪里生成呢？是在“~/”，还是“~/f/”？ 答案是“~/”，也就是a.exe调用的地方，这里才是工作路径，所以程序里面写着在当前路径生成某个文件时，并不是指可执行文件所在的路径，而是工作路径，只不过没有嵌套调用可执行文件时，一般工作路径就是可执行文件的路径而已。</p>
<hr/>
 <h1><a class="anchor" id="设置工作路径"></a>
设置工作路径</h1>
<p>紧接上一个问题，那么如何改变exe运行时候的工作路径呢？ Linux环境下 </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line">...</div><div class="line">chdir(working_dir)</div><div class="line">...</div></div><!-- fragment --><p> 其中，unistd表示unix环境下的标准接口，所以在windows下是用不了的。</p>
<p>Windows环境下 </p><div class="fragment"><div class="line"><span class="preprocessor">#inlcude &lt;direct.h&gt;</span></div><div class="line"></div><div class="line">...</div><div class="line">_chdir(working_dir)</div><div class="line">...</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="typo_sizeof"></a>
初级错误：sizeof()的用法</h1>
<p>如下代码所示，虽然问题很初级，但是有时头晕的时候还是会犯！</p>
<div class="fragment"><div class="line">bin_file.wirte((<span class="keywordtype">char</span>*）imgCT.data, <span class="keyword">sizeof</span>(imgIn.cols*imgIn.rows); <span class="comment">//错误</span></div><div class="line">bin_file.wirte((<span class="keywordtype">char</span>*）imgCT.data, imgIn.cols*imgIn.rows*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)；<span class="comment">//正确</span></div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="初级错误：移位操作符"></a>
初级错误：移位操作符</h1>
<p>C语言中的移位符号不代表赋值，只有用等号赋值之后，变量才会改变。</p>
<div class="fragment"><div class="line">a&gt;&gt;1; <span class="comment">// 不赋值</span></div><div class="line">a = a&gt;&gt;1; <span class="comment">// 赋值</span></div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="隐藏致命：函数内部malloc或者new"></a>
隐藏致命：函数内部malloc或者new</h1>
<p>通常我们希望函数内部给传递的指针参数分配内存，但是这时候传递的指针一定要使用二级指针，否则传递的指针是无法得到新分配的内存地址的。</p>
<hr/>
 <h1><a class="anchor" id="隐藏致命：直方图计算出现越界"></a>
隐藏致命：直方图计算出现越界</h1>
<p>用C语言写histogram函数时，一定要注意max-min后面要加1！例如以下代码</p>
<div class="fragment"><div class="line">*hist = (<span class="keywordtype">unsigned</span> long) malloc(bins*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>));</div><div class="line">memset(*hist, 0, bins*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)</div><div class="line"><span class="keywordtype">int</span> r,c;</div><div class="line"><span class="keywordflow">for</span>(r=0;r&lt;img_height;r+=)</div><div class="line">{</div><div class="line">  <span class="keywordflow">for</span>(c=0; c&lt;img_width; c++)</div><div class="line">  {</div><div class="line">    pixel = img_in[r*img_width+c];</div><div class="line">    loc = (<span class="keywordtype">unsigned</span> long)pixel * (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)bins / (<span class="keywordtype">unsigned</span> long0（max_value-min_value+1）<span class="comment">//这里一定要加1！</span></div><div class="line">    （*hist）[loc] ++ ;</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>这段代码运行时没有出exception，运行结果也是正确的，但是free时却出错了，当时一万个想不通，直到后来发现少了一个加1。 如果少了加1，举个例子，max=255，min=0，当pixel=255时，loc=bins，这时候就会访问越界！是的访问越界时候没有任何提示！ 只有在free时才会显现出来！ 其实max-min并不是整整的个数，真正的个数是max-min+1，例如1到256有256个数，时因为256-1+1=256。</p>
<p>遇到这种摸不着头脑的问题，逐步注释代码排除才是王道！往往认为不可能出现问题的地方才是问题隐藏的最深的地方。</p>
<hr/>
 <h1><a class="anchor" id="cpp_debug_release"></a>
debug和release的不要混用！</h1>
<p>debug时间，2017-09-25 20:00-22：00</p>
<p>一个de了快**两个小时**的bug！ 一段将二进制单通道图像转换成png图像的代码，文件前8个字节是W和H，接着是W*H长度的图像数据。 在imwrite的时候一直出错，W和H读出来的是正确的，搞了半天一直没有头绪，非常的苦恼。 其中还怀疑过是不是QtCreator的问题，然后用VisualStudio试了一遍，发现VisualStudio居然可以！（VS一开始也有问题，但随即发现是自己文件路径不对） 然后仔细对比了一下，发现在VS下链接的OpenCV库文件是opencv_world310d.lib，并且运行的方式是DEBUG。 然而在Creator中我链接的库是opencv_world310.lib，并且运行的方式是DEBUG。 加上后缀"d"之后，终于可以运行了！或者将运行方式改成release，同样也可以运行！ 这个bug在之前的imread函数是没有问题的，这进一步搞混淆了！</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> convert_bin_to_png(<span class="keywordtype">string</span> in_path, <span class="keywordtype">string</span> out_path)</div><div class="line">{</div><div class="line">  ifstream f;</div><div class="line">  f.open(in_path, ios::binary);</div><div class="line">  uint32_t W,H;</div><div class="line">  f.read((<span class="keywordtype">char</span>*)&amp;W, <span class="keyword">sizeof</span>(uint32_t));</div><div class="line">  f.read((<span class="keywordtype">char</span>*)&amp;H, <span class="keyword">sizeof</span>(uint32_t));</div><div class="line">  <span class="keywordtype">char</span> *img = <span class="keyword">new</span> <span class="keywordtype">char</span>[W*H];</div><div class="line">  f.read(img, W*H);</div><div class="line">  Mat save = Mat(H, W, CV8UC1);</div><div class="line">  save.data = (uint8_t)img;</div><div class="line">  imwrite(out_path, save); <span class="comment">// 问题就出现在这一行</span></div><div class="line">  <span class="keyword">delete</span> img;</div><div class="line">}</div></div><!-- fragment --><p><b>教训：</b> lib库的引用一定要**遵循规范**！debug版本的代码要引用debug版本的lib，release版本的代码要引用release版本的库。 举一反三，x64的编译方式用x64的库，x86的编译方式用x86的库，vc08，vc10，vc12的库最好也一致！</p>
<hr/>
 <h1><a class="anchor" id="处理三通道图像出错？"></a>
处理三通道图像出错？</h1>
<p>2017-09-26, debug时间，10分钟。</p>
<p>下面一段代码将float图像转换成color_map形式，在处理每个通道的数据时，地址没有写对，W和c忘记乘上通道数了。 </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> cvt2color(<span class="keywordtype">float</span> *img, uint32_t W, uint32_t H, uint8_t **img_out)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> uint32_t N = 511;</div><div class="line">    uint8_t color_map[N][3];</div><div class="line">    <span class="keywordflow">for</span>(uint32_t i=0; i&lt;N; i++)</div><div class="line">    {</div><div class="line">        color_map[i][0] = i&lt;=255 ? 255-i : 0;</div><div class="line">        color_map[i][1] = i&lt;=255 ? i : 510-i;</div><div class="line">        color_map[i][2] = i&lt;=255 ? 0 : i-255;</div><div class="line">    }</div><div class="line"></div><div class="line">    *img_out = <span class="keyword">new</span> uint8_t[3*W*H];</div><div class="line">    <span class="keywordflow">for</span>(uint32_t r=0; r&lt;H; r++)</div><div class="line">        <span class="keywordflow">for</span>(uint32_t c=0; c&lt;W; c++)</div><div class="line">        {</div><div class="line">            int32_t loc = (int32_t)img[r*W+c] + 255;</div><div class="line">            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;3; k++)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span>(loc &lt; 0)</div><div class="line">                    loc = 0;</div><div class="line">                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(loc &gt; 510)</div><div class="line">                    loc = 510;</div><div class="line">                <span class="comment">// (*img_out)[r*W+c+k] = color_map[(uint32_t)loc][k]; // 错误</span></div><div class="line">                (*img_out)[r*3*W+3*c+k] = color_map[(uint32_t)loc][k]; <span class="comment">// 正确</span></div><div class="line"></div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>**教训：**处理多通道图像一定要注意寻址和通道的关系。</p>
<hr/>
 <h1><a class="anchor" id="定点化的程序反而更慢？"></a>
定点化的程序反而更慢？</h1>
<p>2017-10-11 debug时间：1天</p>
<p>使用定点小数进行优化，在PC上跑是有1/5的时间减少的，但是移植到ARM上，发现反而运行的时间还更长，差不多是1.5倍左右，很纳闷。</p>
<p>原因：最后查到了程序中有一个限制运算数量的宏常数写错了。。。。本来要限制在XXX_YYY=1500的，结果却成了XXX_APP_YYY=5000。 两个宏搞混了，原因就是在pc版只有XXX_YYY这个宏，而在ARM版本上却将XXX_YYY偷偷改成了XXX_APP_YYY。</p>
<p><b>教训：</b></p>
<ol type="1">
<li>不能太相信develop中的程序，任何地方都有可能变更，要有强大的内心的面对这一切，也要有仔细观察的耐心。</li>
<li>产生问题的根本原因是在线工程和离线工程代码不一致的问题，这时候如果使用基于多态实现的在线离线应用程序框架，就不会出现问题，因为在线工程和离线工程将会使用同一个宏。</li>
</ol>
<hr/>
 <h1><a class="anchor" id="数据读取出错？"></a>
数据读取出错？</h1>
<p>2017-10-26 debug时长：2小时 debug发现数据存储结构不符合预期，但是没找到为什么不符合预期，第二天重新测了一组数据，又变好了！</p>
<p>教训：嵌入式程序数据记录可能会有偶然问题，发现问题时一定要多测几组（至少两组）来先确认问题！</p>
<hr/>
 <h1><a class="anchor" id="fabs出错？"></a>
fabs出错？</h1>
<p>2017-11-03 debug时长：10分钟 描述：fabs函数结果不对？这个问题很明显，printf出来就有问题。 原因：没有加入math.h头文件，这个原因很坑爹，因为没有头文件，编译居然不报错。 一个只依赖于标准库的程序没遇到过这种问题，这个问题出现在引用别人的库的前提下，有的时候别人的库定义了这个函数，但是并不是正确的，或者是编译选项选择忽略这种问题，例如我在工作中，就发现一些找不到定义的函数只有警告而不是错误。</p>
<p>教训：这种明显很奇怪的问题，一般是和环境相关的，头文件什么的不要省，而且要怀疑提出编译的人。</p>
<hr/>
 <h1><a class="anchor" id="加了新功能，然后其他“不相关”模块崩溃？"></a>
加了新功能，然后其他“不相关”模块崩溃？</h1>
<p>2017-12-06 debug时长， 30分钟</p>
<p>原因，通过指针形式获取别的线程结构体内容，然后处理过程中别的线程改动了那块内存上的数据，有可能那块内存已经被释放。</p>
<p>报错那是比较轻的结果，最可怕的是，刚好没有报错，那块内存是别人在用的，你偷偷踩了别人的内存，而别人的模块除了错还完全不知道什么回事。 俗称“踩内存”，如果不报错，这种问题很难发现，目前唯一比较有效的debug方式就是git回滚+review代码。</p>
<p>如果不确定通过指针获取的结构体会不会变，那么一定要自己定义一个结构体变量，然后传入地址，再memcpy一下，不要贪图简单，直接定义个指针传入。</p>
<hr/>
 <h1><a class="anchor" id="ifstream读取数据总是在特定长度出错？"></a>
ifstream读取数据总是在特定长度出错？</h1>
<p>2018-01-02 debug时长，1个小时</p>
<p>描述：读取一个binary文件，文件的长度为143360字节，然而只能读取106个字节，之后总是fail，摸不着头脑</p>
<p>原因：读取binary文件的时候没有加入ios::bianry参数。</p>
<p>没有加入ios::binary参数，文件就会通过文本形式读取，读取时0x1A被认为是end of file，所以读取总在特定长度失效。</p>
<hr/>
 <h1><a class="anchor" id="文件总是读写有问题？"></a>
文件总是读写有问题？</h1>
<p>2018-01-08 debug时长，2个小时</p>
<p>读出的文件不对？看看二进制参数是不是正确的，百分之八十的问题都来自这里。 C语言看"wb"和"rb"，c++看ios::binary</p>
<hr/>
 <h1><a class="anchor" id="根本无错的地方crash？"></a>
根本无错的地方crash？</h1>
<p>2018-12-07 debug时长，1个小时</p>
<p>一开始在A地方crash，屏蔽了代码A之后又在B处崩溃，同样屏蔽代码B后又在C处崩溃，这个ABC处怎么看都不会崩溃，根本没有指针寻址操作。 后来一段一段代码屏蔽，才发现问题出现在ABC之前的X处，X处代码出现指针越界，但是本身运行过程中居然没问题，等到后面运行其他函数时，就爆发了，这种bug非常可怕，很容易误导人。</p>
<hr/>
 <h1><a class="anchor" id="根本无错的地方crash（2）？"></a>
根本无错的地方crash（2）？</h1>
<p>2019-01-28 debug时长，1小时</p>
<p>迷迷糊糊加了一些代码之后，然后本来无错的地方突然crash了？crash的地方和改动地方差别相差很远，而且完全没有动过，怎么会crash呢？ 有一种可能一定要警醒，就是前置代码内存越界了！</p>
<hr/>
 <h1><a class="anchor" id="非4整数倍尺寸图像存成bmp文件出错？"></a>
非4整数倍尺寸图像存成bmp文件出错？</h1>
<p>bmp标准强行要求图像宽度4字节对齐，所以一定要非4整数倍宽度一定要补齐。</p>
<hr/>
 <h1><a class="anchor" id="多线程启动函数注意局部变量的使用"></a>
多线程启动函数注意局部变量的使用</h1>
<p>新线程里的某些静态数组数据，用着用着内容就被改的面目全非了，特别像踩内存。 一般新的线程都是由一个启动函数来启动的，启动函数将参数传入新线程，这时候要注意，一定不要将启动函数的局部变量传入新线程，因为启动函数是会结束的，局部变量是要被销毁的！ 实际上新线程还没有启动的时候，启动函数就可能已经结束了。</p>
<hr/>
 <h1><a class="anchor" id="ifstream"></a>
eof函数</h1>
<p>用ifstream的eof来判断是否到达文件结尾是有坑的，即使到达了文件结尾，eof也不会马上为true，必须再读一次数据，eof才会返回true。 比较简洁的判断文件是否到结尾的方式是 </p><div class="fragment"><div class="line">ifstream ifs;</div><div class="line"><span class="keywordflow">while</span>(ifs.peek())</div><div class="line">{</div><div class="line">}</div></div><!-- fragment --><hr/>
 <h1><a class="anchor" id="引用不能重新改变对象。"></a>
引用不能重新改变对象。</h1>
<p>无法根据=符号来重新改编引用对象，因为无法区分是重新引用还是对当前引用的赋值。 </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="zk_note.html">学习笔记</a></li><li class="navelem"><a class="el" href="programming.html">编程</a></li><li class="navelem"><a class="el" href="cpp.html">编程语言：C++</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
